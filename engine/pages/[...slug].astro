---
import Layout from "@/layouts/Layout.astro"
import Hero from "@/components/Hero/Hero.astro"

import * as components from "@/components"
import { resolveLinks, getContentRest as getContent } from "engine/contentful"

const { content, sys } = await getContent(Astro.locals.engine.ref)

if (sys.contentType !== "page") {
  return Astro.redirect("/")
}
//console.log(content.modules)
//const heroes: Hero[] = content.heroCollection.items || []

//const hero = includes.Entry.find((c) => c.sys.id === content.hero[0].sys.id)
const contentModules: Array<ContentModule> = content.modules || []
const links = await resolveLinks(contentModules)

function ucfirst(v: string) {
  return String(v).charAt(0).toUpperCase() + String(v).slice(1)
}
---

<Layout title={content.metaTitle || content.title}>
  <main>
    <div class="wrap">
      <h1>{content.title}</h1>
      <time>{sys.updatedAt}</time>
    </div>
    <!-- <TestCard data={{ title: "plop" }} /> -->
    <Hero data={content.hero[0]} />
    {
      contentModules.map(async (entry) => {
        entry.type = ucfirst(entry.sys.contentType.sys.id)
        if (entry && components[entry.type]) {
          if ("link" in entry) entry.link = links[entry.sys.id]
          const Component = components[entry.type] as any
          return <Component data={entry.fields} />
          //return <Component links={links} data={entry} />
        }

        // entries.map((entry) => {
        //   if ("link" in entry) entry.link = links[entry.sys.id]
        //   //if (entry.type === "Section") return <Section data={entry} />
        //   //if (entry.type === "EditorialCard") return <Components.EditorialCard data={entry} />
        // })

        //if (entry.type === "Section") return <Components.Section data={entry} />
        //if (entry.type === "Text") return <Components.Text data={entry} />
      })
    }
    <components.Foo data={{ title: "simple astro component test" }} />
    <components.Alert text="react component rendered on the server" />
    <components.Dummy data={{ title: "another simple astro component bringing its own styles" }} />
    <!-- <Button>Example</Button> -->
  </main>
</Layout>
